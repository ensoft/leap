#!/bin/bash

# -------------------------------------------------------------
# setup - Sets up marple
# July-Aug 2018 - Hrutvik Kanabar, Franz Nowak
# -------------------------------------------------------------

# TODO find better way of silencing commands than redirect to /dev/null

if command -v python3 &>/dev/null; then
    echo Python 3 is installed.
else
    echo Fatal error: Python 3 is not installed.
    exit 1
fi

# Set up marple directory
MARPLE_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"

# Set up spinner so user knows script is not frozen
show_spinner()
{
    PID=$!
    i=1
    sp="/-\|"
    echo -n ' '
    while [ -d /proc/$PID ]
    do
        printf "\b${sp:i++%${#sp}:1}"
	sleep 1
    done
    echo -ne '\b'
}

printf "Updating... "
sudo apt-get -qq update > /dev/null &
show_spinner
printf "Done.\n"

printf "Installing linux-tools... "
sudo apt-get -qq install linux-tools-generic linux-tools-common linux-tools-`uname -r` > /dev/null &
show_spinner
printf "Done.\n"

# Setup alias for pip install
alias pipi="sudo -H python3 -m pip install"

printf "Installing venv... "
sudo apt-get -qq install python3-venv > /dev/null &
show_spinner
printf "Done.\n"

printf "Creating virtual environment... "
python3 -m venv marple_env
source marple_env/bin/activate
printf "Done.\n"

printf "Installing Python requirements..."
python3 -m pip install -U -q pip virtualenv > /dev/null &
show_spinner
python3 -m pip install -r ./requirements.txt > /dev/null &
show_spinner
printf "Done.\n"

# Deactivate virtual environment
deactivate

printf "Installing dependencies for vpp/g2... "
sudo apt-get -qq install libgtk2.0-dev > /dev/null &
show_spinner
printf "Done.\n"

printf "Adding vpp/g2 submodule... "
# initialise the submodule
git submodule --quiet init > /dev/null &
show_spinner
git submodule --quiet update > /dev/null &
show_spinner
printf "Done.\n"

printf "Configuring vpp/g2... "
# do some config
cd vpp/src
libtoolize --quiet > /dev/null &
show_spinner
aclocal > /dev/null &
show_spinner
autoconf > /dev/null &
show_spinner
automake --add-missing > /dev/null &
show_spinner
autoreconf > /dev/null &
show_spinner
printf "Done.\n"

printf "Installing vpp/g2... "
# install g2
cd ../build-root
make --silent g2-install > /dev/null &
show_spinner
printf "Done.\n"

printf "Creating symlink... "
cd /usr/bin
sudo ln -s ${MARPLE_DIR}/marple marple
source ~/.bashrc
printf "Done.\n"
